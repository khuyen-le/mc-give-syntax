

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('jsonlite')
library('tidyverse')
library("purrr")
library("uuid")
library("here")
```

```{r create response file}
files <- list.files(file.path(getwd(), "../data_pilot/RAW_DATA"), pattern = "*.json")

df <- files %>%
       map_df(~fromJSON(file.path(getwd(), "../data_pilot/RAW_DATA", .), flatten = TRUE)) %>%
  pull(trials) %>%
  group_by(subject_id) %>%
  mutate(subject_id = UUIDgenerate())

df.responses <- df %>%
  filter(phase == "test") %>%
  select(subject_id, condition, category, label, selected_group, selected_group_location, selected_group_semantics) %>%
  mutate(concurrent_func = ifelse(selected_group_semantics == "con", 1, 0))

write.csv(df.responses, "../data_pilot/PROCESSED_DATA/pilot_response.csv", row.names = FALSE)
```

```{r}
df.demog_raw <- df %>%
  filter (phase == "demog" | demog_question == "demog_meta") %>%
  select(subject_id, user_lang, response, demog_question) %>% 
  group_by(subject_id) %>%
  unnest(response) %>%
  mutate(response = as.character(response)) %>%
  mutate(response = ifelse(response == "", NA, response)) %>%
  rename(demog_response = response)

df.demog_age_gender <- df %>%
  filter (demog_question == "demog_age_gender") %>%
  select(subject_id, user_lang, response, demog_question) %>% 
  group_by(subject_id) %>%
  mutate(response = map(toJSON(response), ~ fromJSON(.) %>% as.data.frame())) %>%
  unnest(response) %>%
  select(-demog_question) %>%
  pivot_longer(
    cols = -c(subject_id, user_lang), 
    names_to = "demog_question", 
    values_to = "demog_response"
  ) %>%
  mutate(demog_response = as.character(demog_response))

df.demog_age_gender <- df %>%
  filter (demog_question == "demog_age_gender") %>%
  select(subject_id, user_lang, response, demog_question) %>% 
  group_by(subject_id) %>%
  mutate(response = map(toJSON(response), ~ fromJSON(.) %>% as.data.frame())) %>%
  unnest(response) %>%
  select(-demog_question) %>%
  pivot_longer(
    cols = -c(subject_id, user_lang), 
    names_to = "demog_question", 
    values_to = "demog_response"
  ) %>%
  mutate(demog_response = as.character(demog_response))

df.demog <- bind_rows(df.demog_raw, df.demog_age_gender) %>%
  filter(demog_question != "demog_age_gender") %>%
  arrange(subject_id) %>%
  rowwise() %>%
  mutate(demog_question = substring(text = demog_question, first = 7))


write.csv(df.demog, "../data_pilot/PROCESSED_DATA/pilot_demog.csv", row.names = FALSE)
```




```{r}
ggplot(data = df.responses, 
       mapping = aes(x = condition, y = concurrent_func)) + 
  geom_jitter(aes(color = subject_id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  theme(legend.position = "none")
```

```{r}

```


